{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://fieldscout-copilot/contracts/schemas/Playbook.json",
  "title": "Playbook",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "playbookId",
    "crop",
    "region",
    "version",
    "updatedAt",
    "rules"
  ],
  "properties": {
    "playbookId": {
      "type": "string",
      "pattern": "^pbk_[a-z0-9_]+$"
    },
    "crop": {
      "type": "string",
      "enum": ["grape"]
    },
    "region": {
      "type": "string",
      "enum": ["yolo_county_ca"]
    },
    "version": {
      "type": "integer",
      "minimum": 1
    },
    "updatedAt": {
      "type": "string",
      "format": "date-time"
    },
    "rules": {
      "type": "object",
      "additionalProperties": false,
      "required": ["rule_pm_moderate", "rule_heat_moderate"],
      "properties": {
        "rule_pm_moderate": {
          "$ref": "#/$defs/Rule"
        },
        "rule_heat_moderate": {
          "$ref": "#/$defs/Rule"
        }
      }
    }
  },
  "$defs": {
    "Rule": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "ruleId",
        "issue",
        "severity",
        "constraints",
        "action",
        "timing",
        "editablePaths"
      ],
      "properties": {
        "ruleId": {
          "type": "string",
          "pattern": "^rule_[a-z0-9_]+$"
        },
        "issue": {
          "type": "string",
          "enum": ["powdery_mildew", "heat_stress"]
        },
        "severity": {
          "type": "string",
          "enum": ["low", "moderate", "high"]
        },
        "constraints": {
          "type": "object",
          "additionalProperties": false,
          "required": ["maxWindKph"],
          "properties": {
            "maxWindKph": {
              "type": "number",
              "minimum": 0,
              "maximum": 100
            },
            "avoidInversion": {
              "type": "boolean"
            },
            "maxRelativeHumidityPct": {
              "type": "number",
              "minimum": 0,
              "maximum": 100
            },
            "minHoursWithoutRain": {
              "type": "number",
              "minimum": 0,
              "maximum": 48
            },
            "maxTemperatureC": {
              "type": "number",
              "minimum": -30,
              "maximum": 70
            },
            "irrigationWindowLocal": {
              "type": "string",
              "pattern": "^[0-2][0-9]:[0-5][0-9]-[0-2][0-9]:[0-5][0-9]$"
            }
          }
        },
        "action": {
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "instructions"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["spray", "irrigate", "monitor"]
            },
            "instructions": {
              "type": "string",
              "minLength": 1
            }
          }
        },
        "timing": {
          "type": "object",
          "additionalProperties": false,
          "required": ["baseWindowHours", "weatherAdjustments"],
          "properties": {
            "baseWindowHours": {
              "type": "object",
              "additionalProperties": false,
              "required": ["startOffsetHours", "endOffsetHours"],
              "properties": {
                "startOffsetHours": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 24
                },
                "endOffsetHours": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 48
                }
              }
            },
            "weatherAdjustments": {
              "type": "array",
              "items": {
                "type": "object",
                "additionalProperties": false,
                "required": [
                  "feature",
                  "condition",
                  "shiftStartMinutes",
                  "shiftEndMinutes",
                  "rationaleTag"
                ],
                "properties": {
                  "feature": {
                    "type": "string",
                    "enum": [
                      "inversionPresent",
                      "humidityLayering",
                      "windShearProxy",
                      "sprayWindowScore",
                      "diseaseRiskScore",
                      "heatStressScore"
                    ]
                  },
                  "condition": {
                    "type": "string"
                  },
                  "shiftStartMinutes": {
                    "type": "integer",
                    "minimum": -240,
                    "maximum": 240
                  },
                  "shiftEndMinutes": {
                    "type": "integer",
                    "minimum": -240,
                    "maximum": 240
                  },
                  "rationaleTag": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "editablePaths": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string"
          }
        }
      }
    }
  }
}
